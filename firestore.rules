rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ================================
    // Helper Functions
    // ================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check role only if user is authenticated
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ================================
    // LINKS
    // ================================
    match /links/{linkId} {
      // Anyone can read a single link document if they have the ID, and can query by shortId.
      allow get: if true;
      allow list: if true;

      // Only the owner can create, update, or delete their own links.
      allow create, update, delete: if isOwner(request.resource.data.userId);
    }

    // ================================
    // CLICKS (Visits)
    // ================================
    match /clicks/{clickId} {
      // Anyone can create a click document (register a visit).
      allow create: if true;

      // Nobody can read, update, or delete individual click documents directly.
      allow read, update, delete: if false;
    }

    // ================================
    // USERS
    // ================================
    match /users/{userId} {
      // Anyone can get a user document (needed for the client to check account status).
      allow get: if true;
      
      // A user can only write to their own document.
      allow write: if isOwner(userId);
    }
    
    // ================================
    // NOTIFICATIONS
    // ================================
    match /notifications/{notificationId} {
      // A user can read, write, and list their own notifications.
      allow read, write, list: if isOwner(resource.data.userId);
    }

    // ================================
    // CPM HISTORY
    // ================================
    match /cpmHistory/{historyId} {
      // Authenticated users can read CPM history.
      allow read: if isAuthenticated();
      // Only admins can change CPM history.
      allow write: if isAdmin();
    }

    // ================================
    // PAYOUT REQUESTS
    // ================================
    match /payoutRequests/{requestId} {
      // A user can read and list their own requests. Admins can read any.
      allow read, list: if isOwner(resource.data.userId) || isAdmin();
      // A user can create their own requests.
      allow create: if isOwner(request.resource.data.userId);
      // Only an admin can update a request (to approve/reject it).
      allow update: if isAdmin();
    }

    // ================================
    // SUPPORT TICKETS
    // ================================
    match /supportTickets/{ticketId} {
      // The owner or an admin can read, create, and update a ticket.
      allow read, create, update, list: if isOwner(resource.data.userId) || isAdmin();
      
      match /messages/{messageId} {
         // The ticket owner or an admin can read/create messages within it.
         allow read, create: if isOwner(get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId) || isAdmin();
      }
    }
  }
}
