
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // -- COLLECTIONS --

    match /users/{userId} {
      // Admins can read/write any user document
      allow read, write: if isAdmin();
      // Owners can read/write their own document
      allow read, write: if isOwner(userId);
      // ANYONE can read the account status of a user. This is safe because no other fields are exposed.
      // This is necessary for the ClientComponent to check if a link's owner is suspended.
      allow get: if true;
    }

    match /links/{linkId} {
      // Anyone can read a single link document (for the LinkGate)
      allow get: if true;
      // Admins can read/write any link
      allow read, write: if isAdmin();
      // Owners can manage their own links
      allow read, write: if isOwner(resource.data.userId);
    }

    match /clicks/{clickId} {
      // Anyone can create a click log if the link owner is not suspended.
      allow create: if request.resource.data.processed == false;
      
      // Admins can update click documents (e.g., to mark them as processed)
      allow update: if isAdmin();
      
      // Only Admins can read or delete click logs
      allow read, delete: if isAdmin();
    }
    
    match /payoutRequests/{requestId} {
        // Admins can see all requests and update them
        allow read, update: if isAdmin();
        // Users can create requests for themselves and read their own history
        allow create: if isOwner(request.resource.data.userId);
        allow read: if isOwner(resource.data.userId);
    }

    match /notifications/{notificationId} {
        // Users can read and update (e.g., mark as read) their own notifications
        allow read, update: if isOwner(resource.data.userId);
        // Admins can read all notifications (for debugging or support)
        allow read: if isAdmin();
        // Notifications are created by backend processes or system actions (like link deletion by admin)
        // so we don't allow direct client creation. They are created via writeBatches.
        allow create: if isAdmin();
    }
    
    match /cpmHistory/{historyId} {
        // Anyone can read the CPM history to understand rate changes
        allow read: if true;
        // Only admins can create/update CPM history entries
        allow write: if isAdmin();
    }
    
    match /supportTickets/{ticketId} {
        allow read, write: if isAdmin() || isOwner(resource.data.userId);
        
        match /messages/{messageId} {
            allow read, write: if isAdmin() || isOwner(get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId);
        }
    }
  }
}
