rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // USER-SPECIFIC ACCESS
    match /users/{userId} {
      // An authenticated user can read and update their own profile.
      allow read, update: if request.auth.uid == userId;
      // Any authenticated user can create their own profile document.
      allow create: if request.auth.uid == userId;
    }
    
    // ADMIN-ONLY ACCESS
    // Admins need broader access to manage the system.
    match /users/{userId} {
      allow get, list: if isAdmin();
    }
    match /links/{linkId} {
      allow read, write: if isAdmin();
    }
    match /payoutRequests/{requestId} {
      allow read, write: if isAdmin();
    }
    match /cpmHistory/{cpmId} {
      allow read, write: if isAdmin();
    }
    match /notifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    // PUBLIC AND USER-SPECIFIC ACCESS
    match /links/{linkId} {
      // Anyone can fetch a single link to be redirected.
      allow get: if true;
      // Logged-in users can list their own links.
      allow list: if request.auth != null && request.query.where.userId == request.auth.uid;
      // Logged-in users can create links for themselves.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Logged-in users can update/delete their own links.
      allow update, delete: if request.auth.uid == resource.data.userId;
    }

    match /clicks/{clickId} {
        // Anyone can create a click document (from the link gate).
        allow create: if true;
        // Logged-in users can read clicks for links they own. Admins can read any.
        allow read, list: if isAdmin() || 
                           (request.auth != null && exists(/databases/$(database)/documents/links/$(request.query.where.linkId)) &&
                            get(/databases/$(database)/documents/links/$(request.query.where.linkId)).data.userId == request.auth.uid);
    }

    match /payoutRequests/{requestId} {
        // A user can create a payout request for themselves.
        allow create: if request.auth.uid == request.resource.data.userId;
        // A user can read their own payout requests.
        allow read, list: if request.auth.uid == resource.data.userId;
    }

    match /cpmHistory/{cpmId} {
        // Any authenticated user can read the CPM history.
        allow read, list: if request.auth != null;
    }

    match /notifications/{notificationId} {
        // A user can only read their own notifications.
        allow read, list: if request.auth.uid == resource.data.userId;
    }
  }
}
