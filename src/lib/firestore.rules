
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{userId} {
      // Users can read and update their own profile.
      allow get, update: if request.auth.uid == userId;
      // Admins can list and read any user profile.
      allow list, get: if isAdmin();
    }

    match /links/{linkId} {
      // Unauthenticated users/server can read a single link for the gate page.
      allow get: if true;
      // Logged-in users can read, update, and delete their own links.
      allow read, write, delete: if request.auth.uid == resource.data.userId;
      // Admins can list and delete any link.
      allow list, delete: if isAdmin();
    }

    match /clicks/{clickId} {
      // Anyone can create a click log, as long as the link's owner is not suspended.
      // This is the core of the visit registration.
      allow create: if request.resource.data.processed == false
                    && get(/databases/$(database)/documents/links/$(request.resource.data.linkId)).data.userId == get(/databases/$(database)/documents/users/$(get(/databases/$(database)/documents/links/$(request.resource.data.linkId)).userId)).uid
                    && get(/databases/$(database)/documents/users/$(get(/databases/$(database)/documents/links/$(request.resource.data.linkId)).userId)).accountStatus != 'suspended';
      // No one can read or modify click logs directly.
      allow read, update, delete: if false;
    }

    match /payoutRequests/{requestId} {
      // Users can create their own payout requests.
      allow create: if request.auth.uid == request.resource.data.userId;
      // Users can list and read their own payout requests. This is the fix.
      allow list, get: if request.auth.uid == resource.data.userId;
      // Admins can list and update any payout request.
      allow list, update: if isAdmin();
    }
    
    match /cpmHistory/{historyId} {
        // Only admins can read and write CPM history.
        allow read, write: if isAdmin();
    }

    match /notifications/{notificationId} {
      // Users can manage their own notifications.
      allow read, write: if request.auth.uid == resource.data.userId;
      // Admins can read all notifications.
      allow list, get: if isAdmin();
    }

    match /supportTickets/{ticketId} {
       // Users can create and manage their own tickets.
       allow create: if request.auth.uid == request.resource.data.userId;
       allow read, update: if request.auth.uid == resource.data.userId;

       // Admins can manage all tickets.
       allow list, get, update: if isAdmin();
       
       match /messages/{messageId} {
         // Users and admins can read/write messages in tickets they have access to.
         allow read, create: if get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userId == request.auth.uid || isAdmin();
       }
    }
  }
}
